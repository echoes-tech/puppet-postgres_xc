#!/bin/bash

gtm_port=<%= @gtm_port %>
gtm_standby_name=<%= @gtm_standby_name %>
user=<%= @user %>

continue=1
while [ $continue -eq 1 ]
do
port_status=`nmap gtm -p$gtm_port | grep $gtm_port | cut -d" " -f2`
  if [ $port_status == 'closed' ]
  then
    sleep 1.5 # sleep pour s'assurer que le gtm standby sera promote avant la reco des gtm proxies
    sudo -u $user gtm_ctl reconnect -Z gtm_proxy -D /var/lib/postgresql/gtm_proxy -o "-s $gtm_standby_name -t $gtm_port"
    continue=0
  fi
  sleep 1
done

